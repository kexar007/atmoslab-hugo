name: Deploy Hugo site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Strapi Data
        env:
          STRAPI_BASE_URL: ${{ secrets.STRAPI_BASE_URL }}
          STRAPI_API_TOKEN: ${{ secrets.STRAPI_API_TOKEN }}
        run: |
          mkdir -p data
          
          # First get total count with pageSize=1
          COUNT_RESPONSE=$(curl -f -s -X GET "${{ secrets.STRAPI_BASE_URL }}/people?populate=*&pagination[pageSize]=1" \
               -H "Authorization: Bearer ${{ secrets.STRAPI_API_TOKEN }}" \
               -H "Content-Type: application/json")
          
          echo "Debug: Response received"
          echo "$COUNT_RESPONSE" | head -20  # Show first 20 lines for debugging
          
          TOTAL=$(echo "$COUNT_RESPONSE" | jq -r '.meta.pagination.total // 0')
          echo "Total items found: $TOTAL"
          
          if [ "$TOTAL" -eq 0 ]; then
            echo "No items found, creating empty response"
            echo '{"data":[],"meta":{"pagination":{"page":1,"pageSize":25,"pageCount":0,"total":0}}}' > data/strapi_people_with_images.json
          else
            # Fetch all items in one request using the total count
            curl -f -X GET "${{ secrets.STRAPI_BASE_URL }}/people?populate=*&pagination[pageSize]=$TOTAL" \
                 -H "Authorization: Bearer ${{ secrets.STRAPI_API_TOKEN }}" \
                 -H "Content-Type: application/json" \
                 -o data/strapi_people_with_images.json
          fi

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build
        run: hugo --minify

      # --- NEW DEBUGGING STEP IS HERE ---
      - name: List files in public directory
        run: ls -R public
      # --- END OF NEW STEP ---

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4